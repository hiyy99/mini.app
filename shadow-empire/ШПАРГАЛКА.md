# Shadow Empire — Шпаргалка

## Структура проекта
```
shadow-empire/
├── bot.py              — Telegram бот
├── start.py            — Точка входа для Railway (запускает бэк + бот)
├── run_all.py          — Локальный запуск (бэк + туннель + бот)
├── requirements.txt    — Python зависимости
├── game.db             — База данных SQLite (НЕ коммитить!)
├── backend/
│   ├── main.py         — FastAPI бэкенд (вся логика игры)
│   ├── game_config.py  — Конфиг: цены, награды, баланс
│   ├── database.py     — Инициализация БД
│   └── game_logic.py   — Расчёты механик
└── frontend/
    ├── index.html      — HTML (тут кэш-версия ?v=XX)
    ├── css/style.css   — Стили
    └── js/app.js       — Весь фронтенд JavaScript
```

---

## Railway (хостинг)

### Переменные окружения (Railway → Settings → Variables)
| Переменная | Значение |
|---|---|
| `BOT_TOKEN` | `8553722467:AAFWR7NJUVtDveeSezAoOuuLoM8GssB3l8w` |
| `WEBAPP_URL` | `https://app-production-7f1d.up.railway.app/static/index.html` |
| `PORT` | `8000` |

### Деплой
Автоматический при пуше в GitHub. Просто пушь — Railway сам подхватит.

---

## Частые операции

### 1. Изменить баланс / цены / награды
**Файл:** `backend/game_config.py`

Примеры:
- Награды за босса → ищи `GANG_BOSSES`, поле `reward_pool`
- Награды за войну → ищи `GANG_WAR_CONFIG`, поля `winner_reward`, `loser_reward`
- Цены бизнесов → ищи `BUSINESSES`
- Цены улучшений банды → ищи `GANG_UPGRADES`
- Кейсы/лут → ищи `CASES`

### 2. Изменить фронтенд (UI)
**Файл:** `frontend/js/app.js`

### 3. Изменить HTML-структуру
**Файл:** `frontend/index.html`

### 4. Изменить бота (кнопки, команды)
**Файл:** `bot.py`

---

## Как деплоить изменения

### Шаг 1: Обновить кэш-версию (ОБЯЗАТЕЛЬНО!)
Telegram кэширует файлы. Без этого изменения НЕ БУДУТ видны.

**В `frontend/index.html`** — найди и замени `?v=XX` на `?v=XX+1`:
```
css/style.css?v=37  →  css/style.css?v=38
js/app.js?v=37      →  js/app.js?v=38
```

**В `bot.py`** — найди и замени `_v=XX`:
```
_v=37  →  _v=38
```

### Шаг 2: Закоммитить и запушить
```bash
cd /c/Users/Admin/shadow-empire
git add bot.py frontend/index.html frontend/js/app.js backend/main.py backend/game_config.py
git commit -m "Описание что изменил"
git push
```

### Шаг 3: Обновить Menu Button (кнопка в левом углу Telegram)
```bash
python -c "
import httpx
TOKEN = '8553722467:AAFWR7NJUVtDveeSezAoOuuLoM8GssB3l8w'
url = 'https://app-production-7f1d.up.railway.app?_v=38'
r = httpx.post(f'https://api.telegram.org/bot{TOKEN}/setChatMenuButton', json={
    'menu_button': {'type': 'web_app', 'text': 'Играть', 'web_app': {'url': url}}
}, timeout=30)
print(r.json())
"
```
**Замени `_v=38` на текущую версию!**

### Шаг 4: Подождать 1-2 минуты
Railway деплоит автоматически после пуша.

---

## Проверка логов Railway
```bash
cd /c/Users/Admin/shadow-empire
railway logs
```

## Проверка статуса
```bash
curl -s https://app-production-7f1d.up.railway.app/api/init -X POST | python -m json.tool
```

---

## Локальный запуск (без Railway)
```bash
cd /c/Users/Admin/shadow-empire
python run_all.py
```
Запустит бэкенд + Cloudflare туннель + бота. Нужен cloudflared.

---

## Работа с базой данных

### Посмотреть данные игрока
```bash
python -c "
import sqlite3
db = sqlite3.connect('C:/Users/Admin/shadow-empire/game.db')
db.row_factory = sqlite3.Row
r = db.execute('SELECT * FROM players WHERE telegram_id=ТВОЙ_ID').fetchone()
print(dict(r))
"
```

### Добавить деньги игроку (локальная БД)
```bash
python -c "
import sqlite3
db = sqlite3.connect('C:/Users/Admin/shadow-empire/game.db')
db.execute('UPDATE players SET cash=cash+1000000 WHERE telegram_id=ТВОЙ_ID')
db.commit()
print('Done')
"
```

**Важно:** На Railway своя БД, локальная БД — это копия. Чтобы менять данные на проде, нужен API эндпоинт.

---

## Git — частые команды

```bash
# Посмотреть что изменилось
git status
git diff

# Закоммитить конкретные файлы
git add файл1 файл2
git commit -m "Описание"
git push

# Посмотреть историю коммитов
git log --oneline -10

# Откатить файл к последнему коммиту
git checkout -- путь/к/файлу
```

---

## Telegram Bot API — полезные команды

### Обновить Menu Button
```bash
python -c "
import httpx
TOKEN = '8553722467:AAFWR7NJUVtDveeSezAoOuuLoM8GssB3l8w'
url = 'https://app-production-7f1d.up.railway.app?_v=ВЕРСИЯ'
r = httpx.post(f'https://api.telegram.org/bot{TOKEN}/setChatMenuButton', json={
    'menu_button': {'type': 'web_app', 'text': 'Играть', 'web_app': {'url': url}}
}, timeout=30)
print(r.json())
"
```

### Отправить сообщение всем (broadcast)
Пока нет эндпоинта. Нужно добавить если понадобится.

---

## Важные ссылки
- **GitHub:** https://github.com/hiyy99/mini.app
- **Railway:** https://railway.app (зайти → проект → логи/настройки)
- **Домен:** https://app-production-7f1d.up.railway.app
- **Бот:** @shadow_empire_game_bot
- **Канал:** https://t.me/shadowempire_official
- **Чат:** https://t.me/shadowempire_chat

---

## Текущие версии (обнови после каждого деплоя)
- Кэш-версия: **v=37**
- Последний коммит: `2f2cd86`

---

## Если что-то сломалось

1. **Игра не загружается** → Проверь логи: `railway logs`
2. **Старая версия показывается** → Обновил кэш `?v=XX`? Обновил Menu Button?
3. **403 ошибка на /api/init** → Проблема с валидацией initData. Открой логи.
4. **Бот не отвечает** → Возможно конфликт (два бота одновременно). Проверь что локальный не запущен.
5. **Railway не деплоит** → Проверь что `git push` прошёл. Зайди в Railway dashboard.
